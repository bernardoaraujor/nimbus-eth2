#!/bin/bash

# Copyright (c) 2020-2021 Status Research & Development GmbH. Licensed under
# either of:
# - Apache License, version 2.0
# - MIT license
# at your option. This file may not be copied, modified, or distributed except
# according to those terms.

set -e

: "${NBC_BINARY:=/usr/bin/nimbus_beacon_node}"
: "${NETWORK:="mainnet"}"
: "${NODE_ID:=0}"
: "${DATA_DIR_NAME:="shared_${NETWORK}_${NODE_ID}"}"
: "${DATA_DIR:="/var/lib/nimbus/${DATA_DIR_NAME}"}"
: "${BASE_P2P_PORT:=9000}"
: "${BASE_RPC_PORT:=9190}"

WEB3_HELP="To monitor the Eth1 validator deposit contract, you'll need to pair
the Nimbus beacon node with a Web3 provider capable of serving Eth1
event logs. This could be a locally running Eth1 client such as Geth
or a cloud service such as Infura. For more information please see
our setup guides:

https://status-im.github.io/nimbus-eth2/eth1.html"

USAGE="Nimbus Beacon Node launcher script
usage:

NETWORK=\"network\" WEB3_URL=\"wss://xxx\" $(basename "$0")

where the following Environment Variables:
    \$NETWORK selects the network: prater, pyrmont, mainnet (default)
    \$WEB3_URL sets eth1 web3 provider URL (wss:// or https://).

$WEB3_HELP"

while getopts 'h' OPTION; do
  case "$OPTION" in
    h) echo "$USAGE"
       exit
       ;;
   \?) printf "illegal option: -%s\n" "$OPTARG" >&2
       echo "$USAGE" >&2
       exit 1
       ;;
  esac
done
shift $((OPTIND - 1))

if [ $NETWORK != "mainnet" -a $NETWORK != "prater" -a $NETWORK != "pyrmont" ]; then
  echo "Invalid network! Valid options:
- mainnet
- prater
- pyrmont
"
  exit 1
fi

if [ -z "${WEB3_URL}" ]; then
  echo -n "Please enter a Web3 provider URL: "
  read WEB3_URL
fi

EXTRA_ARGS=""
if [[ "${WEB3_URL}" != "" ]]; then
  EXTRA_ARGS="--web3-url=${WEB3_URL}"
fi

# Allow the binary to receive signals directly.
exec ${WINPTY} ${NBC_BINARY} \
  --network=${NETWORK} \
  --data-dir="${DATA_DIR}" \
  --log-file="${DATA_DIR}/nbc_bn_$(date +"%Y%m%d%H%M%S").log" \
  --tcp-port=$(( ${BASE_P2P_PORT} + ${NODE_ID} )) \
  --udp-port=$(( ${BASE_P2P_PORT} + ${NODE_ID} )) \
  --rpc \
  --rpc-port=$(( ${BASE_RPC_PORT} +${NODE_ID} )) \
  ${EXTRA_ARGS} \
  $@
